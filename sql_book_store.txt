
CREATE TYPE "enum_promotions_loai_giam_gia" AS ENUM ('percentage', 'fixed_amount');
CREATE TYPE "enum_promotions_pham_vi_ap_dung" AS ENUM ('all', 'category', 'product');
CREATE TYPE "enum_products_product_type" AS ENUM ('printed', 'ebook');
CREATE TYPE "enum_orders_trang_thai_don_hang" AS ENUM ('pending', 'confirmed', 'shipping', 'delivered', 'cancelled');


-- =================================================================
--  PHẦN 2: TẠO CẤU TRÚC CÁC BẢNG (TABLES)
-- =================================================================

-- Bảng `roles` (Vai trò)
CREATE TABLE "roles" (
  "id" BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "ten_quyen" VARCHAR(255) NOT NULL UNIQUE
);

-- Bảng `users` (Người dùng)
CREATE TABLE "users" (
  "id" BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "role_id" BIGINT NOT NULL DEFAULT 2 REFERENCES "roles"("id") ON DELETE SET NULL,
  "ten_dang_nhap" VARCHAR(100) NOT NULL UNIQUE,
  "email" VARCHAR(255) NOT NULL UNIQUE,
  "mat_khau" VARCHAR(255) NOT NULL,
  "ho_ten" VARCHAR(255),
  "phone" VARCHAR(20),
  "dia_chi" VARCHAR(255),
  "trang_thai" BOOLEAN DEFAULT TRUE,
  "createdAt" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updatedAt" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Bảng `categories` (Danh mục)
CREATE TABLE "categories" (
  "id" BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "ten_danh_muc" VARCHAR(255) NOT NULL,
  "mo_ta" TEXT,
  "danh_muc_cha_id" BIGINT REFERENCES "categories"("id") ON DELETE SET NULL,
  "createdAt" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updatedAt" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Bảng `products` (Sản phẩm - Sách)
CREATE TABLE "products" (
  "id" BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "danh_muc_id" BIGINT NOT NULL REFERENCES "categories"("id") ON DELETE SET NULL,
  "ten_sach" VARCHAR(255) NOT NULL,
  "tac_gia" VARCHAR(255),
  "mo_ta_ngan" TEXT,
  "gia_bia" DECIMAL(12, 2) NOT NULL,
  "so_luong_ton_kho" INTEGER NOT NULL DEFAULT 0,
  "nha_xuat_ban" VARCHAR(255),
  "nam_xuat_ban" INTEGER,
  "img" VARCHAR(255),
  "trang_thai" BOOLEAN DEFAULT TRUE,
  "product_type" "enum_products_product_type" DEFAULT 'printed',
  "ebook_url" VARCHAR(255),
  "createdAt" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updatedAt" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);
-- Tạo index để tìm kiếm theo tên sách nhanh hơn
CREATE INDEX "idx_product_ten_sach" ON "products"("ten_sach");


-- Bảng `carts` và `cart_items` (Giỏ hàng)
CREATE TABLE "carts" (
  "id" BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "user_id" BIGINT NOT NULL UNIQUE REFERENCES "users"("id") ON DELETE CASCADE,
  "createdAt" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updatedAt" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);
CREATE TABLE "cart_items" (
  "id" BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "cart_id" BIGINT NOT NULL REFERENCES "carts"("id") ON DELETE CASCADE,
  "product_id" BIGINT NOT NULL REFERENCES "products"("id") ON DELETE CASCADE,
  "so_luong" INTEGER NOT NULL DEFAULT 1
);

-- Bảng `orders` và `order_items` (Đơn hàng)
CREATE TABLE "orders" (
  "id" BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "user_id" BIGINT REFERENCES "users"("id") ON DELETE SET NULL,
  "ten_nguoi_nhan" VARCHAR(255) NOT NULL,
  "email_nguoi_nhan" VARCHAR(255) NOT NULL,
  "sdt_nguoi_nhan" VARCHAR(20) NOT NULL,
  "dia_chi_giao_hang" VARCHAR(255) NOT NULL,
  "ghi_chu_khach_hang" TEXT,
  "tong_tien_hang" DECIMAL(15, 2) NOT NULL,
  "phi_van_chuyen" DECIMAL(10, 2) DEFAULT 0.00,
  "tong_thanh_toan" DECIMAL(15, 2) NOT NULL,
  "phuong_thuc_thanh_toan" VARCHAR(50) NOT NULL,
  "trang_thai_don_hang" "enum_orders_trang_thai_don_hang" DEFAULT 'pending',
  "trang_thai_thanh_toan" BOOLEAN DEFAULT FALSE,
  "createdAt" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updatedAt" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);
CREATE TABLE "order_items" (
  "id" BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "order_id" BIGINT NOT NULL REFERENCES "orders"("id") ON DELETE CASCADE,
  "product_id" BIGINT REFERENCES "products"("id") ON DELETE SET NULL,
  "so_luong_dat" INTEGER NOT NULL,
  "don_gia" DECIMAL(12, 2) NOT NULL
);

-- Bảng `reviews` (Đánh giá, bình luận)
CREATE TABLE "reviews" (
  "id" BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "user_id" BIGINT NOT NULL REFERENCES "users"("id") ON DELETE CASCADE,
  "product_id" BIGINT NOT NULL REFERENCES "products"("id") ON DELETE CASCADE,
  "rating" INTEGER,
  "comment" TEXT,
  "parent_id" BIGINT REFERENCES "reviews"("id") ON DELETE CASCADE,
  "createdAt" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updatedAt" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Bảng `slideshows` (Slide quảng cáo)
CREATE TABLE "slideshows" (
  "id" BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "image_url" VARCHAR(255) NOT NULL,
  "tieu_de" VARCHAR(255),
  "phu_de" VARCHAR(255),
  "link_to" VARCHAR(255),
  "thu_tu_hien_thi" INTEGER DEFAULT 0,
  "trang_thai" BOOLEAN DEFAULT TRUE,
  "createdAt" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updatedAt" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Bảng `promotions` (Khuyến mãi)
CREATE TABLE "promotions" (
  "id" BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "ma_khuyen_mai" VARCHAR(255) NOT NULL UNIQUE,
  "mo_ta" TEXT NOT NULL,
  "loai_giam_gia" "enum_promotions_loai_giam_gia" NOT NULL,
  "gia_tri_giam" DECIMAL(10, 2) NOT NULL,
  "dieu_kien_don_hang_toi_thieu" DECIMAL(15, 2) DEFAULT 0,
  "ngay_bat_dau" TIMESTAMPTZ NOT NULL,
  "ngay_ket_thuc" TIMESTAMPTZ NOT NULL,
  "so_luong_gioi_han" INTEGER,
  "so_luong_da_su_dung" INTEGER DEFAULT 0,
  "pham_vi_ap_dung" "enum_promotions_pham_vi_ap_dung" DEFAULT 'all',
  "danh_sach_ap_dung" BIGINT[],
  "trang_thai" BOOLEAN DEFAULT TRUE,
  "createdAt" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updatedAt" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Bảng `combos` và `combo_items`
CREATE TABLE "combos" (
  "id" BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "ten_combo" VARCHAR(255) NOT NULL,
  "mo_ta" TEXT,
  "img" VARCHAR(255),
  "gia_combo" DECIMAL(15, 2) NOT NULL,
  "trang_thai" BOOLEAN DEFAULT TRUE,
  "createdAt" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updatedAt" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);
CREATE TABLE "combo_items" (
  "id" BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "combo_id" BIGINT NOT NULL REFERENCES "combos"("id") ON DELETE CASCADE,
  "product_id" BIGINT NOT NULL REFERENCES "products"("id") ON DELETE CASCADE
);

-- Bảng `ebook_download_links`
CREATE TABLE "ebook_download_links" (
  "id" BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "user_id" BIGINT NOT NULL REFERENCES "users"("id") ON DELETE CASCADE,
  "product_id" BIGINT NOT NULL REFERENCES "products"("id") ON DELETE CASCADE,
  "order_id" BIGINT NOT NULL REFERENCES "orders"("id") ON DELETE CASCADE,
  "download_token" VARCHAR(255) NOT NULL UNIQUE,
  "expires_at" TIMESTAMPTZ NOT NULL,
  "is_used" BOOLEAN DEFAULT FALSE,
  "createdAt" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updatedAt" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);


-- =================================================================
--  PHẦN 3: THÊM DỮ LIỆU MẪU (SAMPLE DATA)
-- =================================================================

-- 1. Thêm vai trò
INSERT INTO "roles" ("id", "ten_quyen") VALUES (1, 'admin'), (2, 'user');

-- 2. Thêm người dùng (Mật khẩu là "123456", đã được mã hóa. Bạn cần dùng mật khẩu này để đăng nhập)
INSERT INTO "users" ("id", "role_id", "ten_dang_nhap", "email", "mat_khau", "ho_ten", "phone", "dia_chi") VALUES
(1, 1, 'admin', 'admin@bookstore.com', '$2a$10$fI0A3.R63P.xGq8C3d3l3.yH6xQv3F5sWJvP/YgY7nUa5.yH7p.eS', 'Quản Trị Viên', '0123456789', '123 Admin St, Admin City'),
(2, 2, 'nguoianhem', 'thienlanh@email.com', '$2a$10$fI0A3.R63P.xGq8C3d3l3.yH6xQv3F5sWJvP/YgY7nUa5.yH7p.eS', 'Người Anh Em Thiện Lành', '0987654321', '456 User Ave, User Town');

-- 3. Thêm danh mục
INSERT INTO "categories" ("id", "ten_danh_muc", "danh_muc_cha_id") VALUES
(1, 'Sách Kinh Tế', NULL),
(2, 'Văn Học', NULL),
(3, 'Phát triển bản thân', 1),
(4, 'Văn học Việt Nam', 2);

-- 4. Thêm sản phẩm
INSERT INTO "products" ("id", "danh_muc_id", "ten_sach", "tac_gia", "gia_bia", "so_luong_ton_kho", "nha_xuat_ban", "product_type", "ebook_url") VALUES
(1, 3, 'Đắc Nhân Tâm', 'Dale Carnegie', 99000.00, 100, 'NXB Tổng hợp TP.HCM', 'printed', NULL),
(2, 3, 'Nhà Giả Kim', 'Paulo Coelho', 79000.00, 80, 'NXB Hội Nhà Văn', 'printed', NULL),
(3, 4, 'Số Đỏ', 'Vũ Trọng Phụng', 65000.00, 50, 'NXB Văn Học', 'printed', NULL),
(4, 1, 'Tư Duy Nhanh và Chậm', 'Daniel Kahneman', 189000.00, 40, 'NXB Trẻ', 'ebook', 'tu-duy-nhanh-va-cham.pdf');

-- 5. Thêm một đơn hàng đã hoàn thành cho user 'nguoianhem'
INSERT INTO "orders" ("id", "user_id", "ten_nguoi_nhan", "email_nguoi_nhan", "sdt_nguoi_nhan", "dia_chi_giao_hang", "tong_tien_hang", "phi_van_chuyen", "tong_thanh_toan", "phuong_thuc_thanh_toan", "trang_thai_don_hang", "trang_thai_thanh_toan") VALUES
(1, 2, 'Người Anh Em Thiện Lành', 'thienlanh@email.com', '0987654321', '456 User Ave, User Town', 178000.00, 20000.00, 198000.00, 'COD', 'delivered', true);
INSERT INTO "order_items" ("order_id", "product_id", "so_luong_dat", "don_gia") VALUES
(1, 1, 1, 99000.00),
(1, 2, 1, 79000.00);

-- 6. Thêm một đánh giá cho sản phẩm đã mua
INSERT INTO "reviews" ("user_id", "product_id", "rating", "comment") VALUES
(2, 1, 5, 'Sách rất hay và ý nghĩa, một cuốn sách gối đầu giường!');

-- 7. Thêm một khuyến mãi
INSERT INTO "promotions" ("ma_khuyen_mai", "mo_ta", "loai_giam_gia", "gia_tri_giam", "ngay_bat_dau", "ngay_ket_thuc", "trang_thai") VALUES
('DOANHAY', 'Giảm 10% cho toàn bộ đơn hàng', 'percentage', 10.00, '2023-01-01', '2024-12-31', true);

-- 8. Thêm slide
INSERT INTO "slideshows" ("image_url", "tieu_de", "link_to") VALUES
('https://example.com/slide1.jpg', 'Sách Mới Mùa Hè', '/categories/1'),
('https://example.com/slide2.jpg', 'Best Seller - Đắc Nhân Tâm', '/products/1');

-- Cập nhật lại chuỗi sequence cho các bảng để tránh lỗi khi insert mới
-- (Do chúng ta đã insert ID thủ công)
SELECT setval('roles_id_seq', (SELECT MAX(id) FROM roles), true);
SELECT setval('users_id_seq', (SELECT MAX(id) FROM users), true);
SELECT setval('categories_id_seq', (SELECT MAX(id) FROM categories), true);
SELECT setval('products_id_seq', (SELECT MAX(id) FROM products), true);
SELECT setval('orders_id_seq', (SELECT MAX(id) FROM orders), true);

-- Kết thúc script
-- Chúc người anh em thiện lành có một kỳ đồ án thành công!